<!DOCTYPE html>
<html lang="en" data-accent-color="cyan" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>4.9. Focus Search - optrace 1.7.5 documentation</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="4.10. Paraxial Analysis" href="tma.html" /><link rel="prev" title="4.8. Image Classes" href="image.html" />
      <link rel="canonical" href="https://drocheam.github.io/optrace/usage/focus.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"dark");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=d48c410d" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=81da21d3" />
    <!--intentionally blank so there are no external fonts loaded-->
    <meta property="og:type" content="website"/>
<meta property="og:url" content="https://drocheam.github.io/optrace/usage/focus.html"/>
<meta property="og:title" content="4.9. Focus Search"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      
      
      <strong>optrace</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"><ul><li class="link"><a href=".././examples.html">Examples</a></li><li class="link"><a href=".././installation.html">Installation</a></li><li class="link"><a href=".././usage/index.html">User Guide</a></li><li class="link">
          <a href="https://github.com/drocheam/optrace">
            <span>GitHub Repo</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><!--custom github logo so we don't need to connect to some icon provider-->
<div class="sy-head-socials"><a href="https://github.com/drocheam/optrace" aria-label="GitHub">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github-icon lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
  <a href="https://github.com/drocheam/optrace/releases" aria-label="Releases">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-icon lucide-package"><path d="M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z"/><path d="M12 22V12"/><polyline points="3.29 7 12 12 20.71 7"/><path d="m7.5 4.27 9 5.15"/></svg>
  </a>
</div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../examples.html">1. Example Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">3. Quickstart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">4. User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">4.1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="surfaces.html">4.2. Base Shapes (Surface, Line, Point)</a></li>
<li class="toctree-l2"><a class="reference internal" href="elements.html">4.3. Elements (Lens, Ray Source,  …)</a></li>
<li class="toctree-l2"><a class="reference internal" href="group.html">4.4. Geometry Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="raytracer.html">4.5. Raytracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="refraction_index.html">4.6. Refractive Indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="spectrum.html">4.7. Spectrum Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="image.html">4.8. Image Classes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.9. Focus Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="tma.html">4.10. Paraxial Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="convolve.html">4.11. PSF Convolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="plots.html">4.12. Plotting Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="gui.html">4.13. GUI Interaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="gui_automation.html">4.14. GUI Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html">4.15. Advanced Topics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../details/index.html">5. Implementation Details</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../details/sampling.html">5.1. Property Sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../details/tracing.html">5.2. Tracing Procedure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../details/hurb.html">5.3. Heisenberg Uncertainty Ray Bending</a></li>
<li class="toctree-l2"><a class="reference internal" href="../details/image_spectrum.html">5.4. Image and Spectrum Rendering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../details/matrix_analysis.html">5.5. Ray Transfer Matrix Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../details/convolution.html">5.6. PSF Convolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../details/focus.html">5.7. Focus Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../details/color.html">5.8. Color Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../details/misc.html">5.9. Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">6. API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/structure.html">6.1. Library Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace.html">6.2. Global Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer.html">6.3. tracer Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_color.html">6.4. tracer.color Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_geometry.html">6.5. tracer.geometry Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_geometry_surface.html">6.6. tracer.geometry.surface Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_image.html">6.7. tracer.image Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_spectrum.html">6.8. tracer.spectrum Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_presets.html">6.9. tracer.presets Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_plots.html">6.10. plots Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_gui.html">6.11. gui Submodule</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">7. Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/testing.html">7.1. Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/documentation.html">7.2. Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/packaging.html">7.3. Packaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/notes.html">7.4. Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/changelog.html">7.5. Changelog</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#focus-modes">4.9.1. Focus Modes</a></li>
<li><a class="reference internal" href="#limitations">4.9.2. Limitations</a></li>
<li><a class="reference internal" href="#usage">4.9.3. Usage</a></li>
<li><a class="reference internal" href="#cost-plot">4.9.4. Cost Plot</a></li>
<li><a class="reference internal" href="#mathematical-formulations">4.9.5. Mathematical Formulations</a><ul>
<li><a class="reference internal" href="#rms-spot-size">4.9.5.1. RMS Spot Size</a></li>
<li><a class="reference internal" href="#irradiance-variance">4.9.5.2. Irradiance Variance</a></li>
<li><a class="reference internal" href="#image-sharpness">4.9.5.3. Image Sharpness</a></li>
<li><a class="reference internal" href="#image-center-sharpness">4.9.5.4. Image Center Sharpness</a></li>
</ul>
</li>
</ul>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">optrace</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="index.html"><span itemprop="name"><span class="section-number">4. </span>User Guide</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name"><span class="section-number">4.9. </span>Focus Search</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <section id="focus-search">
<span id="usage-focus"></span><h1><span class="section-number">4.9. </span>Focus Search<a class="headerlink" href="#focus-search" title="Link to this heading">¶</a></h1>
<section id="focus-modes">
<h2><span class="section-number">4.9.1. </span>Focus Modes<a class="headerlink" href="#focus-modes" title="Link to this heading">¶</a></h2>
<p>The following focus methods are available:</p>
<div class="table-wrapper colwidths-given docutils container">
<table class="docutils align-left">
<colgroup>
<col style="width: 37.5%" />
<col style="width: 62.5%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>RMS Spot Size</strong></p></td>
<td><p>minimal variance of the lateral ray position</p></td>
</tr>
<tr class="row-even"><td><p><strong>Irradiance Variance</strong></p></td>
<td><p>highest irradiance variance</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Image Sharpness</strong></p></td>
<td><p>sharpest edges for the whole image</p></td>
</tr>
<tr class="row-even"><td><p><strong>Image Center Sharpness</strong></p></td>
<td><p>sharpest edges in the center region of the image</p></td>
</tr>
</tbody>
</table>
</div>
<p>The methods use all available rays, for better results the scene should have been traced with much rays as possible.
The methods are explained in more detail down below.</p>
<p>There are multiple applications for focus search, below you can find method recommendations.</p>
<dl class="simple">
<dt><strong>Case 1</strong>: Perfect, nearly ideal focal point</dt><dd><ul class="simple">
<li><p><strong>Examples:</strong> Focus of an ideal lens. Paraxial illumination of a real lens</p></li>
<li><p><strong>Preferred methods:</strong> RMS Spot Size. Irradiance Variance is also suitable, but has worse performance.</p></li>
</ul>
</dd>
</dl>
<p>Below you can find an example.
Both RMS Spot Size and Irradiance Variance find a similar focal position, differing only in 70 µm.
Note the different scaling of the images.</p>
<div class="table-wrapper table-borderless docutils container" id="id1">
<table class="table-borderless docutils align-default" id="id1">
<caption><span class="caption-number">Table 4.12 </span><span class="caption-text">Comparison between “RMS Spot Size” (left) and “Irradiance Variance” (right) in linear (top) and logarithmic
lightness values (bottom).
Example <a class="reference internal" href="../examples.html#example-double-gauss"><span class="std std-ref">Double Gauss</span></a>. Focus search for ray source 0 only. 2 million rays.</span><a class="headerlink" href="#id1" title="Link to this table">¶</a></caption>
<tbody>
<tr class="row-odd"><td><figure class="align-center">
<a class="dark-light reference internal image-reference" href="../_images/focus_gauss_rms.webp"><img alt="../_images/focus_gauss_rms.webp" class="dark-light" src="../_images/focus_gauss_rms.webp" style="width: 450px;" />
</a>
</figure>
</td>
<td><figure class="align-center">
<a class="dark-light reference internal image-reference" href="../_images/focus_gauss_var.webp"><img alt="../_images/focus_gauss_var.webp" class="dark-light" src="../_images/focus_gauss_var.webp" style="width: 450px;" />
</a>
</figure>
</td>
</tr>
</tbody>
</table>
</div>
<dl class="simple">
<dt><strong>Case 2:</strong>  Strong aberrations or no distinct focal point</dt><dd><ul class="simple">
<li><p><strong>Examples:</strong> Lens with large spherical aberration, multifocal lens</p></li>
<li><p><strong>Preferred methods:</strong> Irradiance Variance.</p></li>
</ul>
</dd>
</dl>
<p>In the following example there are noticeable amounts of spherical aberration.
RMS Spot Size tries the minimize the radial distance of the outer rays, sacrificing a sharp core.
Irradiance Variance correctly finds a suitable focal position.
Note the logarithmic plots, that show the outer rays.
In the right case they merely contribute to the image, but they have large impact on the RMS, why the RMS method fails.</p>
<div class="table-wrapper table-borderless docutils container" id="id2">
<table class="table-borderless docutils align-default" id="id2">
<caption><span class="caption-number">Table 4.13 </span><span class="caption-text">Comparison between “RMS Spot Size” (left) and “Irradiance Variance” (right) in linear (top) and logarithmic
lightness values (bottom).
Example <a class="reference internal" href="../examples.html#example-spherical-aberration"><span class="std std-ref">Spherical Aberration</span></a>.</span><a class="headerlink" href="#id2" title="Link to this table">¶</a></caption>
<tbody>
<tr class="row-odd"><td><figure class="align-center">
<a class="dark-light reference internal image-reference" href="../_images/focus_sphere_rms.webp"><img alt="../_images/focus_sphere_rms.webp" class="dark-light" src="../_images/focus_sphere_rms.webp" style="width: 450px;" />
</a>
</figure>
</td>
<td><figure class="align-center">
<a class="dark-light reference internal image-reference" href="../_images/focus_sphere_var.webp"><img alt="../_images/focus_sphere_var.webp" class="dark-light" src="../_images/focus_sphere_var.webp" style="width: 450px;" />
</a>
</figure>
</td>
</tr>
<tr class="row-even"><td><figure class="align-center">
<a class="dark-light reference internal image-reference" href="../_images/focus_sphere_rms_log.webp"><img alt="../_images/focus_sphere_rms_log.webp" class="dark-light" src="../_images/focus_sphere_rms_log.webp" style="width: 450px;" />
</a>
</figure>
</td>
<td><figure class="align-center">
<a class="dark-light reference internal image-reference" href="../_images/focus_sphere_var_log.webp"><img alt="../_images/focus_sphere_var_log.webp" class="dark-light" src="../_images/focus_sphere_var_log.webp" style="width: 450px;" />
</a>
</figure>
</td>
</tr>
</tbody>
</table>
</div>
<dl class="simple">
<dt><strong>Case 3:</strong> Finding the optimal image distance</dt><dd><ul class="simple">
<li><p><strong>Example:</strong> Actual image position (not just the paraxial) in a multi-lens setup.</p></li>
<li><p><strong>Preferred methods:</strong> Image Sharpness.
With large amounts of curvature of field Image Center Sharpness should be selected,
to find a best-fit focus for the image center region.</p></li>
</ul>
</dd>
</dl>
<p>For the image sharpness methods to work best, a source image with high contrast and sharp edges should be used.
For instance, the grid or Siemens star presets, depicted in table <a class="reference internal" href="image.html#table-image-presets-aberrations"><span class="std std-numref">Table 4.11</span></a>.</p>
<p>In the following figure you can find an example for image sharpness focussing for a setup with
large amounts of field of curvature. While in the left case more image regions are somewhat sharp, in the right case
the sharpness is optimized for the center region.</p>
<div class="table-wrapper table-borderless docutils container" id="id3">
<table class="table-borderless docutils align-default" id="id3">
<caption><span class="caption-number">Table 4.14 </span><span class="caption-text">Comparison between “Image Sharpness” (left) and “Image Center Sharpness” (right) for a setup with
large amounts of field of curvature. Example <a class="reference internal" href="../examples.html#example-image-render"><span class="std std-ref">Image Render</span></a>, Grid image, pupil of 1mm, 5 million rays.</span><a class="headerlink" href="#id3" title="Link to this table">¶</a></caption>
<tbody>
<tr class="row-odd"><td><figure class="align-center">
<a class="dark-light reference internal image-reference" href="../_images/focus_image_sharpness_grid.webp"><img alt="../_images/focus_image_sharpness_grid.webp" class="dark-light" src="../_images/focus_image_sharpness_grid.webp" style="width: 450px;" />
</a>
</figure>
</td>
<td><figure class="align-center">
<a class="dark-light reference internal image-reference" href="../_images/focus_image_center_sharpness_grid.webp"><img alt="../_images/focus_image_center_sharpness_grid.webp" class="dark-light" src="../_images/focus_image_center_sharpness_grid.webp" style="width: 450px;" />
</a>
</figure>
</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="limitations">
<h2><span class="section-number">4.9.2. </span>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">¶</a></h2>
<p>Limitations include:</p>
<ul class="simple">
<li><p>due to restrictions of the search region the search can’t find a focus that lies between the maximum and minimum
z-value of a surface</p></li>
<li><p>rays absorbed in the search region by the raytracer outline are handled as not absorbed</p></li>
<li><p>in more complex cases only a local minimum is found</p></li>
<li><p>see the limitations of each method below.</p></li>
</ul>
</section>
<section id="usage">
<h2><span class="section-number">4.9.3. </span>Usage<a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p>For focus search you will need to trace the <a class="reference internal" href="../reference/optrace_tracer.html#optrace.tracer.raytracer.Raytracer" title="optrace.tracer.raytracer.Raytracer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Raytracer</span></code></a> geometry.
The <a class="reference internal" href="../reference/optrace_tracer.html#optrace.tracer.raytracer.Raytracer.focus_search" title="optrace.tracer.raytracer.Raytracer.focus_search"><code class="xref py py-meth docutils literal notranslate"><span class="pre">focus_search</span></code></a> function is then called by
passing the focus mode and a starting position.
The search takes place around the starting point, with the search region between the largest z-position of the last
aperture, filter, lens or ray source and the smallest z-position of the next aperture, filter, lens or outline.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">res</span><span class="p">,</span> <span class="n">fsdict</span> <span class="o">=</span> <span class="n">RT</span><span class="o">.</span><span class="n">focus_search</span><span class="p">(</span><span class="s2">&quot;RMS Spot Size&quot;</span><span class="p">,</span> <span class="mf">12.09</span><span class="p">)</span>
</span></pre></div>
</div>
<p><code class="code highlight python docutils literal highlight-python"><span class="n">focus_search</span></code> returns two results, where the first one is a <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.OptimizeResult.html#scipy.optimize.OptimizeResult" title="(in SciPy v1.16.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">scipy.optimize.OptimizeResult</span></code></a>
object with information on the root finding. The found z-position is accessed with <code class="code highlight python docutils literal highlight-python"><span class="n">res</span><span class="o">.</span><span class="n">x</span></code>.
The second return value includes some additional information, for instance needed for the cost plot,
see <a class="reference internal" href="plots.html#focus-cost-plot"><span class="std std-ref">Focus Search Cost Function Plots</span></a>.</p>
<p>By default, rays from all sources are used to focus_search.
Optionally a <code class="code highlight python docutils literal highlight-python"><span class="n">source_index</span></code> parameter can be provided to limit the search to a specific ray source.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">res</span><span class="p">,</span> <span class="n">fsdict</span> <span class="o">=</span> <span class="n">RT</span><span class="o">.</span><span class="n">focus_search</span><span class="p">(</span><span class="s2">&quot;RMS Spot Size&quot;</span><span class="p">,</span> <span class="mf">12.09</span><span class="p">,</span> <span class="n">source_index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></pre></div>
</div>
<p>If the output dictionary <code class="code highlight python docutils literal highlight-python"><span class="n">fsdict</span></code> should include sampled cost function values,
the parameter <code class="code highlight python docutils literal highlight-python"><span class="n">return_cost</span></code> must be set to <code class="code highlight python docutils literal highlight-python"><span class="kc">True</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">res</span><span class="p">,</span> <span class="n">fsdict</span> <span class="o">=</span> <span class="n">RT</span><span class="o">.</span><span class="n">focus_search</span><span class="p">(</span><span class="s2">&quot;RMS Spot Size&quot;</span><span class="p">,</span> <span class="mf">12.09</span><span class="p">,</span> <span class="n">return_cost</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>
</div>
<p>This is required when plotting the cost function using
<a class="reference internal" href="../reference/optrace_plots.html#optrace.plots.misc_plots.focus_search_cost_plot" title="optrace.plots.misc_plots.focus_search_cost_plot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">focus_search_cost_plot</span></code></a>, see <a class="reference internal" href="plots.html#focus-cost-plot"><span class="std std-ref">Focus Search Cost Function Plots</span></a>.
It is deactivated by default to increase the performance of methods <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;RMS Spot Size&quot;</span><span class="p">,</span> <span class="s2">&quot;Irradiance Variance&quot;</span></code></p>
</section>
<section id="cost-plot">
<h2><span class="section-number">4.9.4. </span>Cost Plot<a class="headerlink" href="#cost-plot" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Generally it is recommended to plot the cost function of the optimization so one can see
if there are multiple minima and how distinct the found value is.
The TraceGUI has an option for plotting the cost function.</p>
</div>
<p>See <a class="reference internal" href="plots.html#focus-cost-plot"><span class="std std-ref">Focus Search Cost Function Plots</span></a>.</p>
</section>
<section id="mathematical-formulations">
<h2><span class="section-number">4.9.5. </span>Mathematical Formulations<a class="headerlink" href="#mathematical-formulations" title="Link to this heading">¶</a></h2>
<section id="rms-spot-size">
<h3><span class="section-number">4.9.5.1. </span>RMS Spot Size<a class="headerlink" href="#rms-spot-size" title="Link to this heading">¶</a></h3>
<p>Minimizing the position variance <span class="math notranslate nohighlight">\(\sigma^2\)</span> of lateral ray positions <span class="math notranslate nohighlight">\(x\)</span>
and <span class="math notranslate nohighlight">\(y\)</span> at axial position <span class="math notranslate nohighlight">\(z\)</span>.  All positions are weighted with their power <span class="math notranslate nohighlight">\(P\)</span>
when calculating the weighted variance <span class="math notranslate nohighlight">\(\sigma^2_P\)</span>.
The Pythagorean sum is applied using both variances to get a simple quantity <span class="math notranslate nohighlight">\(R_\text{v}\)</span> for optimization.</p>
<div class="math-wrapper docutils container" id="equation-autofocus-position">
<div class="math notranslate nohighlight" id="equation-autofocus-position">
<span class="eqno">(4.22)<a class="headerlink" href="#equation-autofocus-position" title="Link to this equation">¶</a></span>\[\underset{z \in [z_0, z_1]}{\text{minimize}}~~ R_\text{v}(z) := \sqrt{\sigma^2_{x,P}(z) + \sigma^2_{y,P}(z)}\]</div>
</div>
<p>This procedure is simple and performant.
However, the disadvantage of this method is that it minimizes the position variance of all beams.
For example, if there is a strong outlying halo, the method also tries to keep it as small as possible,
which can lead to a compromise between the halo and the size of the actual focus.</p>
</section>
<section id="irradiance-variance">
<h3><span class="section-number">4.9.5.2. </span>Irradiance Variance<a class="headerlink" href="#irradiance-variance" title="Link to this heading">¶</a></h3>
<p>Renders a two dimensional power histogram <span class="math notranslate nohighlight">\(P(x, y, z)\)</span> for rays at position <span class="math notranslate nohighlight">\(z\)</span>.
This image is divided by pixel area to get an irradiance image <span class="math notranslate nohighlight">\(E(x, y, z)\)</span>.
The approach then calculates the variance of the pixel values and finds the <span class="math notranslate nohighlight">\(z\)</span> with the largest variance.</p>
<div class="math-wrapper docutils container" id="equation-autofocus-image">
<div class="math notranslate nohighlight" id="equation-autofocus-image">
<span class="eqno">(4.23)<a class="headerlink" href="#equation-autofocus-image" title="Link to this equation">¶</a></span>\[\underset{z \in [z_0, z_1]}{\text{maximize}}~~ \log{\sigma_E^2(z)}\]</div>
</div>
<p>The logarithm is applied for a more compact value range.</p>
<p>The most outside rays define the image dimensions, the absolute image size therefore varies along the beam path.
This can be an issue when few rays are far away from the optical axis,
since the resolution suffers because of these marginal rays.</p>
<p>The variance is large when there are bright areas in the image (with much power per area)
or if there is a large variance between pixels, which should be the case if unblurred structures are present.</p>
</section>
<section id="image-sharpness">
<h3><span class="section-number">4.9.5.3. </span>Image Sharpness<a class="headerlink" href="#image-sharpness" title="Link to this heading">¶</a></h3>
<p>As for the method Irradiance Variance, a power histogram is calculated.
The method then maximizes all image gradients, which indicate sharp structures and a high local variance.
The magnitude of the gradient is calculated from the Pythagorean sum of its components.
Maximizing the sum of all squared magnitudes leads to the following expression:</p>
<div class="math-wrapper docutils container" id="equation-autofocus-image-sharpness">
<div class="math notranslate nohighlight" id="equation-autofocus-image-sharpness">
<span class="eqno">(4.24)<a class="headerlink" href="#equation-autofocus-image-sharpness" title="Link to this equation">¶</a></span>\[\underset{z \in [z_0, z_1]}{\text{maximize}} ~~ \sum_{x, y} \left(\left( \frac{\partial P(x, y, z)}{\partial x}\right)^2 + \left( \frac{\partial P(x, y, z)}{\partial y}\right)^2\right)\]</div>
</div>
<p>This is equivalent to:</p>
<div class="math-wrapper docutils container" id="equation-autofocus-image-sharpness2">
<div class="math notranslate nohighlight" id="equation-autofocus-image-sharpness2">
<span class="eqno">(4.25)<a class="headerlink" href="#equation-autofocus-image-sharpness2" title="Link to this equation">¶</a></span>\[\underset{z \in [z_0, z_1]}{\text{maximize}}~~ \sum_{x,y} \left( \frac{\partial P(x, y, z)}{\partial x}\right)^2 + \sum_{x, y} \left( \frac{\partial P(x, y, z)}{\partial y}\right)^2\]</div>
</div>
</section>
<section id="image-center-sharpness">
<h3><span class="section-number">4.9.5.4. </span>Image Center Sharpness<a class="headerlink" href="#image-center-sharpness" title="Link to this heading">¶</a></h3>
<p>The same procedure is performed as for the Image Sharpness method,
but the image is weighted with a rotationally symmetric Hanning window:</p>
<div class="math-wrapper docutils container" id="equation-autofocus-image-center-sharpness">
<div class="math notranslate nohighlight" id="equation-autofocus-image-center-sharpness">
<span class="eqno">(4.26)<a class="headerlink" href="#equation-autofocus-image-center-sharpness" title="Link to this equation">¶</a></span>\[\begin{split}P_w(x, y, z) = P(x, y, z) \cdot \begin{cases} 1 + \cos(\pi r) &amp;~~\text{for}~ r \leq 1\\ 0 &amp; ~~\text{for}~ r &gt; 1\\ \end{cases}\end{split}\]</div>
</div>
<p>Here, <span class="math notranslate nohighlight">\(r\)</span> is calculated from the normalized image coordinates <span class="math notranslate nohighlight">\(x, y \in [-1, 1]\)</span>.</p>
<p>After weighing the image, its power is normalized.
This is done to avoid rewarding images with more light intensity at their center,
as the linearity of scaling also leads to higher partial derivatives.
This is equivalent to optimizing the ratio of sum of derivatives and image intensities.
In the Image Sharpness method this is not required, as the power remains constant in each image,
as all rays are included equally.</p>
</section>
</section>
</section>

        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="image.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title"><span class="section-number">4.8. </span>Image Classes</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="tma.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title"><span class="section-number">4.10. </span>Paraxial Analysis</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright">
      &copy; 2025, Damian Mendroch &nbsp;  &nbsp; 
      <a href="../impressum.html" style="color: var(--pst-color-text-muted)">Impressum</a>
      &nbsp; &nbsp; 
      <a href="../impressum.html" style="color: var(--pst-color-text-muted)">Legal Notice</a>
      <br>
  
    </div>
    <div class="sy-foot-copyright">
      <p>
        Made with
    
        <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
        <a href="https://shibuya.lepture.com">Shibuya theme</a>.
      </p>
    </div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=5b045848"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/shibuya.js?v=e730760c"></script>
      <script>window.MathJax = {"loader": {"load": ["ui/lazy"]}, "options": {"lazyMargin": "400px", "lazyAlwaysTypeset": null}}</script>
      <script defer="defer" src="../_static/mathjax/tex-chtml.js"></script></body>
</html>