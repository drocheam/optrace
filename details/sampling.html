<!DOCTYPE html>
<html lang="en" data-accent-color="cyan" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>5.1. Property Sampling - optrace 1.7.5 documentation</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="5.2. Tracing Procedure" href="tracing.html" /><link rel="prev" title="5. Implementation Details" href="index.html" />
      <link rel="canonical" href="https://drocheam.github.io/optrace/details/sampling.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"dark");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=d48c410d" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=81da21d3" />
    <!--intentionally blank so there are no external fonts loaded-->
    <meta property="og:type" content="website"/>
<meta property="og:url" content="https://drocheam.github.io/optrace/details/sampling.html"/>
<meta property="og:title" content="5.1. Property Sampling"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      
      
      <strong>optrace</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"><ul><li class="link"><a href=".././examples.html">Examples</a></li><li class="link"><a href=".././installation.html">Installation</a></li><li class="link"><a href=".././usage/index.html">User Guide</a></li><li class="link">
          <a href="https://github.com/drocheam/optrace">
            <span>GitHub Repo</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><!--custom github logo so we don't need to connect to some icon provider-->
<div class="sy-head-socials"><a href="https://github.com/drocheam/optrace" aria-label="GitHub">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github-icon lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
  <a href="https://github.com/drocheam/optrace/releases" aria-label="Releases">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-icon lucide-package"><path d="M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z"/><path d="M12 22V12"/><polyline points="3.29 7 12 12 20.71 7"/><path d="m7.5 4.27 9 5.15"/></svg>
  </a>
</div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../examples.html">1. Example Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">3. Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/index.html">4. User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/overview.html">4.1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/surfaces.html">4.2. Base Shapes (Surface, Line, Point)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/elements.html">4.3. Elements (Lens, Ray Source,  …)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/group.html">4.4. Geometry Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/raytracer.html">4.5. Raytracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/refraction_index.html">4.6. Refractive Indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/spectrum.html">4.7. Spectrum Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/image.html">4.8. Image Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/focus.html">4.9. Focus Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/tma.html">4.10. Paraxial Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/convolve.html">4.11. PSF Convolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/plots.html">4.12. Plotting Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/gui.html">4.13. GUI Interaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/gui_automation.html">4.14. GUI Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/advanced.html">4.15. Advanced Topics</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">5. Implementation Details</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.1. Property Sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="tracing.html">5.2. Tracing Procedure</a></li>
<li class="toctree-l2"><a class="reference internal" href="hurb.html">5.3. Heisenberg Uncertainty Ray Bending</a></li>
<li class="toctree-l2"><a class="reference internal" href="image_spectrum.html">5.4. Image and Spectrum Rendering</a></li>
<li class="toctree-l2"><a class="reference internal" href="matrix_analysis.html">5.5. Ray Transfer Matrix Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="convolution.html">5.6. PSF Convolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="focus.html">5.7. Focus Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="color.html">5.8. Color Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc.html">5.9. Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">6. API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/structure.html">6.1. Library Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace.html">6.2. Global Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer.html">6.3. tracer Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_color.html">6.4. tracer.color Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_geometry.html">6.5. tracer.geometry Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_geometry_surface.html">6.6. tracer.geometry.surface Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_image.html">6.7. tracer.image Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_spectrum.html">6.8. tracer.spectrum Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_tracer_presets.html">6.9. tracer.presets Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_plots.html">6.10. plots Submodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/optrace_gui.html">6.11. gui Submodule</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">7. Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/testing.html">7.1. Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/documentation.html">7.2. Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/packaging.html">7.3. Packaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/notes.html">7.4. Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/changelog.html">7.5. Changelog</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#overview">5.1.1. Overview</a></li>
<li><a class="reference internal" href="#ray-properties">5.1.2. Ray Properties</a></li>
<li><a class="reference internal" href="#stochastic-sampling">5.1.3. Stochastic Sampling</a></li>
<li><a class="reference internal" href="#inverse-transform-sampling">5.1.4. Inverse Transform Sampling</a></li>
<li><a class="reference internal" href="#stratified-sampling">5.1.5. Stratified Sampling</a></li>
<li><a class="reference internal" href="#disc-annulus-sampling">5.1.6. Disc/Annulus Sampling</a></li>
<li><a class="reference internal" href="#power-sampling">5.1.7. Power Sampling</a></li>
<li><a class="reference internal" href="#polarization-sampling">5.1.8. Polarization Sampling</a></li>
<li><a class="reference internal" href="#position-sampling">5.1.9. Position Sampling</a><ul>
<li><a class="reference internal" href="#spectrum-sampling">5.1.9.1. Spectrum Sampling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#direction-cone">5.1.10. Direction Cone</a></li>
<li><a class="reference internal" href="#d-direction-sampling">5.1.11. 2D Direction Sampling</a></li>
<li><a class="reference internal" href="#id20">5.1.12. 3D Direction sampling</a></li>
</ul>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">optrace</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="index.html"><span itemprop="name"><span class="section-number">5. </span>Implementation Details</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name"><span class="section-number">5.1. </span>Property Sampling</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <section id="property-sampling">
<h1><span class="section-number">5.1. </span>Property Sampling<a class="headerlink" href="#property-sampling" title="Link to this heading">¶</a></h1>
<section id="overview">
<h2><span class="section-number">5.1.1. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Optrace approximates optical effects by utilizing an Unbiased Quasi Monte Carlo simulation.
Inverse Transform Sampling is used as method for non-uniform random variate generation and Stratified Sampling
as low discrepancy method for the generation of the initial uniform random variable.</p>
<p>A brief description of these terms:</p>
<p><strong>Monte Carlo Simulation:</strong> An algorithm class that approximates a problem with many degrees of freedom
by randomly choosing and simulating a subset of all property and variable combinations.</p>
<p><strong>Quasi Monte Carlo Simulation:</strong> Monte Carlo Simulation, but the sampling is not truly random or pseudo-random.
Instead it has some underlying deterministic or semi-deterministic nature to it. See low-discrepancy methods below.</p>
<p><strong>Unbiased and Biased Methods:</strong> Performing an unbiased Monte Carlo simulation with an infinitely large set of samples
produces an exact description of the physical system.
Starting with few samples, with a larger and larger number the simulation converges towards the correct behavior.
In contrast, a biased simulation never reaches a fully accurate description of the system.
Biased methods can consist of neural network tasks or algorithms that comprise of some simplification of the system model.
A more mathematical descriptions of biasedness can be found here: <a class="footnote-reference brackets" href="#footcite-scratchestimators" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
<p><strong>Non-Uniform Random Variate Generation:</strong> Generating random numbers, while some numbers are more likely
to be chosen than others. The probability distribution is non-uniform.</p>
<p><strong>Low Discrepancy Method:</strong> Methods that generate numbers, where the distribution of these values
only deviates weakly from an equidistribution.
White noise would be a high discrepancy method, since many samples are needed to approximate a true equidistribution.
A regular value grid is a zero discrepancy method, since the values are always regularly distributed.
Low discrepancy methods can be seen as a compromise between those two, trying to create values that fill
an interval or area more uniformly than random values, but are less “obviously deterministic” than simple grids.
Important types of low discrepancy methods include Hamilton and Sobol sequences as well as lattice methods.</p>
<p><strong>Stratified Sampling:</strong> One of many low discrepancy methods. Random values are chosen from a set of sub-groups.
It is guaranteed, that values are chosen from every sub-group (e.g. different intervals), but the values inside
each sub-group are chosen randomly (e.g. random positions inside each interval).
Details on the implementation in optrace are discussed in <a class="reference internal" href="#stratified-sampling"><span class="std std-numref">Section 5.1.5</span></a>.</p>
<p><strong>Inverse Transform Sampling:</strong> Generating non-uniform random numbers according to a known distribution function
by utilizing the inverse transform method.
Details on this method get discussed in <a class="reference internal" href="#inverse-transform"><span class="std std-numref">Section 5.1.4</span></a>.
Important alternative sampling methods include: Importance Sampling, Rejection Sampling</p>
</section>
<section id="ray-properties">
<h2><span class="section-number">5.1.2. </span>Ray Properties<a class="headerlink" href="#ray-properties" title="Link to this heading">¶</a></h2>
<p>When generating rays at the source, there are multiple properties and property distribution.
The number of degrees of freedom is dependent on the source parameters.</p>
<p>In the most simple case, with no degree of freedom, we have a monochromatic point source with parallel light
and equal polarization. On the other end of the spectrum there is an area source with a broad spectrum,
random polarization, an ray orientation dependent on the ray position
and a randomly spreading rays relative to this orientation inside some directional cone.</p>
<div class="table-wrapper colwidths-given docutils container" id="id25">
<table class="docutils align-center" id="id25">
<caption><span class="caption-number">Table 5.1 </span><span class="caption-text">List of ray properties</span><a class="headerlink" href="#id25" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 14.3%" />
<col style="width: 28.6%" />
<col style="width: 28.6%" />
<col style="width: 28.6%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Symbol</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Comment</p></th>
<th class="head"><p>Degrees of Freedom</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(x,y\)</span></p></td>
<td><p>Position</p></td>
<td><p>Point Source, Line Source, Area Source</p></td>
<td><p>0 - 2</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\lambda\)</span></p></td>
<td><p>Wavelength</p></td>
<td><p>Monochromatic or spectrum</p></td>
<td><p>0 - 1</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(P\)</span></p></td>
<td><p>Power</p></td>
<td><p>All rays have equal power</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(s_0\)</span></p></td>
<td><p>orientation vector</p></td>
<td><p>Constant or position dependent</p></td>
<td><p>0 - 2</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(s\)</span></p></td>
<td><p>orientation vector distribution around <span class="math notranslate nohighlight">\(s_0\)</span></p></td>
<td><p>Constant or specified as 1-2 angle distributions</p></td>
<td><p>0 - 2</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(E\)</span></p></td>
<td><p>Polarization</p></td>
<td><p>Constant or specified by angle distribution</p></td>
<td><p>0 - 1</p></td>
</tr>
</tbody>
</table>
</div>
<p>For properties with one or two degrees of freedom the initial uniform random variable is
created using stratified sampling in <a class="reference internal" href="#stratified-sampling"><span class="std std-numref">Section 5.1.5</span></a>.
So for instance for position sampling for an area the two dimensional stratified sampling creates
the random variables <span class="math notranslate nohighlight">\(\mathcal{U}_x,~\mathcal{U}_y\)</span>,
which later gets used as input for position sampling in <a class="reference internal" href="#random-positions-surfaces"><span class="std std-numref">Section 5.1.9</span></a>.</p>
</section>
<section id="stochastic-sampling">
<h2><span class="section-number">5.1.3. </span>Stochastic Sampling<a class="headerlink" href="#stochastic-sampling" title="Link to this heading">¶</a></h2>
<p>In raytracing, it is a standard procedure to randomize the beam properties.
The advantage is that periodic artifacts and sampling errors are exchanged for noise.
This approach is known as stochastic sampling <a class="footnote-reference brackets" href="#footcite-raytracingcook" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<p>An example is the sampling of a surface using a rectangular grid.
With a violation of the sampling theorem aliasing occurs visible artifacts occur.
The effect can be seen in <a class="footnote-reference brackets" href="#footcite-scratchmontecarlo" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>, figure 4, and <a class="footnote-reference brackets" href="#footcite-teschnersampling" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>, slide 8.</p>
<p>However, if the rays are randomly distributed on the surface, the sampling theorem is still violated locally,
but at random locations and randomly strong due to the random spacing between the sampling points.
For the viewer, the resulting aliasing in the image appears as noise.</p>
</section>
<section id="inverse-transform-sampling">
<span id="inverse-transform"></span><h2><span class="section-number">5.1.4. </span>Inverse Transform Sampling<a class="headerlink" href="#inverse-transform-sampling" title="Link to this heading">¶</a></h2>
<p>To calculate a random variable <span class="math notranslate nohighlight">\(\mathcal{T}_{[0,1]}\)</span> with probability distribution function <span class="math notranslate nohighlight">\(\text{pdf}(x)\)</span>
from a uniform random variable <span class="math notranslate nohighlight">\(\mathcal{U}_{[0,~1]}\)</span> we make use of the
inverse transform sampling theorem <a class="footnote-reference brackets" href="#footcite-itswiki" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>.</p>
<div class="math-wrapper docutils container" id="equation-its-t">
<div class="math notranslate nohighlight" id="equation-its-t">
<span class="eqno">(5.1)<a class="headerlink" href="#equation-its-t" title="Link to this equation">¶</a></span>\[\mathcal{T}_{[0,~1]} = \text{cdf}^{-1}\left(\mathcal{U}_{[0,~1]}\right)\]</div>
</div>
<p>Where <span class="math notranslate nohighlight">\(\text{cdf}^{-1}(x)\)</span> is the inverse cumulative distribution function.
The cumulative distribution function <span class="math notranslate nohighlight">\(\text{cdf}\)</span> is defined as integral of
a probability distribution function <span class="math notranslate nohighlight">\(\text{pdf}\)</span>:</p>
<div class="math-wrapper docutils container" id="equation-its-cdf">
<div class="math notranslate nohighlight" id="equation-its-cdf">
<span class="eqno">(5.2)<a class="headerlink" href="#equation-its-cdf" title="Link to this equation">¶</a></span>\[\text{cdf}(x) = \int_{-\infty}^{x} \text{pdf}(\chi) ~\text{d}\chi\]</div>
</div>
<p>This can be generalized for sampling from an interval <span class="math notranslate nohighlight">\([a,~b]\)</span> of a function <span class="math notranslate nohighlight">\(f(x)\)</span> with</p>
<div class="math-wrapper docutils container" id="equation-its-f-interval">
<div class="math notranslate nohighlight" id="equation-its-f-interval">
<span class="eqno">(5.3)<a class="headerlink" href="#equation-its-f-interval" title="Link to this equation">¶</a></span>\[F(x) = \int_{a}^{x} f(\chi)~\text{d}\chi\]</div>
</div>
<p>with <span class="math notranslate nohighlight">\(F(x)\)</span> being injective <span class="math notranslate nohighlight">\(\forall x \in [a, b]\)</span> as:</p>
<div class="math-wrapper docutils container" id="equation-its-t-interval">
<div class="math notranslate nohighlight" id="equation-its-t-interval">
<span class="eqno">(5.4)<a class="headerlink" href="#equation-its-t-interval" title="Link to this equation">¶</a></span>\[\mathcal{T}_{[a,~b]} = \text{F}^{-1}\left(\mathcal{U}_{[\text{F}(a),~\text{F}(b)]}\right)\]</div>
</div>
<p>This fact is also explained in <a class="footnote-reference brackets" href="#footcite-itswiki" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> under “Truncated Distributions”
or in <a class="footnote-reference brackets" href="#footcite-wicklin-2013" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>, last paragraph.</p>
</section>
<section id="stratified-sampling">
<span id="id8"></span><h2><span class="section-number">5.1.5. </span>Stratified Sampling<a class="headerlink" href="#stratified-sampling" title="Link to this heading">¶</a></h2>
<p>Perrier<a class="footnote-reference brackets" href="#footcite-perrier-tel-01801347" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a> goes into great length to examine and compare different low-discrepancy methods
in his work. Regarding simplicity, speed (<a class="footnote-reference brackets" href="#footcite-perrier-tel-01801347" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a>, Figure 3.38), convergence
(<a class="footnote-reference brackets" href="#footcite-perrier-tel-01801347" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a>,Table 3.1),  spectrum and discrepancy (<a class="footnote-reference brackets" href="#footcite-perrier-tel-01801347" id="id12" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a>, Figure 3.37)
the stratified sampling method is most suitable in our raytracer.
This method is described in <a class="footnote-reference brackets" href="#footcite-perrier-tel-01801347" id="id13" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a>, pages 36-37,
while another explanation can be found in <a class="footnote-reference brackets" href="#footcite-wolfediscrepancy" id="id14" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a> under the name <em>Uniform Sampling + Jitter</em>.</p>
<p><strong>One dimension</strong></p>
<p>In one dimension the coordinate set <span class="math notranslate nohighlight">\(\mathcal{X}_N\)</span> with <span class="math notranslate nohighlight">\(N\)</span> values is made of an equally spaced interval
values with an additional dither having the maximum size of one interval spacing.</p>
<div class="math-wrapper docutils container" id="equation-details-sampling-0">
<div class="math notranslate nohighlight" id="equation-details-sampling-0">
<span class="eqno">(5.5)<a class="headerlink" href="#equation-details-sampling-0" title="Link to this equation">¶</a></span>\[\mathcal{X}_N = \left\{\frac{i}{N} + \mathcal{U}_{[0,~1/N]} ~~:~~ i \in \mathbb{N}, ~0 \leq i &lt; N\right\}\]</div>
</div>
<p>The set values then need to be randomly shuffled before using it.</p>
<p><strong>Two dimensions</strong></p>
<p>For simplicity, a square grid is used for stratified sampling in two dimensions.
Each number can be divided into a square and remaining non-square part.
The remaining part gets distributed randomly inside the grid.</p>
<p><span class="math notranslate nohighlight">\(N\)</span> points can be divided into a root number <span class="math notranslate nohighlight">\(N_s = \lfloor\sqrt{N}\rfloor\)</span> and a remaining term
<span class="math notranslate nohighlight">\(\Delta N = N - N_s\)</span>. A set of rectangular grid coordinates with <span class="math notranslate nohighlight">\(N_s\)</span> values in each dimension is
added with a dither to produce a stratified sampled grid <span class="math notranslate nohighlight">\(\mathcal{P}_G\)</span>.</p>
<div class="math-wrapper docutils container" id="equation-details-sampling-1">
<div class="math notranslate nohighlight" id="equation-details-sampling-1">
<span class="eqno">(5.6)<a class="headerlink" href="#equation-details-sampling-1" title="Link to this equation">¶</a></span>\[\mathcal{P}_G = \left\{\left(\left\lfloor\frac{i}{N_s}\right\rfloor +
         \mathcal{U}_{[0,~1/N_s]}, ~i \;\text{mod}\; N_s + \mathcal{U}_{[0,~1/N_s]} \right)
         ~~:~~ i \in \mathbb{N}, ~0 \leq i &lt; N_s^2\right\}\]</div>
</div>
<p>Remaining points <span class="math notranslate nohighlight">\(\mathcal{P}_\Delta\)</span> are generated randomly inside the grid,
being equivalent to white noise sampling:</p>
<div class="math-wrapper docutils container" id="equation-details-sampling-2">
<div class="math notranslate nohighlight" id="equation-details-sampling-2">
<span class="eqno">(5.7)<a class="headerlink" href="#equation-details-sampling-2" title="Link to this equation">¶</a></span>\[\mathcal{P}_\Delta = \left\{\left(\mathcal{U}_{[0,~1]}, ~\mathcal{U}_{[0,~1]} \right)
~~:~~ i \in \mathbb{N}, ~0 \leq i &lt; \Delta N\right\}\]</div>
</div>
<p>The point set <span class="math notranslate nohighlight">\(\mathcal{P}\)</span> with size <span class="math notranslate nohighlight">\(N\)</span> is then the union of both:</p>
<div class="math-wrapper docutils container" id="equation-details-sampling-3">
<div class="math notranslate nohighlight" id="equation-details-sampling-3">
<span class="eqno">(5.8)<a class="headerlink" href="#equation-details-sampling-3" title="Link to this equation">¶</a></span>\[\mathcal{P} = \mathcal{P}_G \cup \mathcal{P}_\Delta\]</div>
</div>
<p>The set <span class="math notranslate nohighlight">\(\mathcal{P}\)</span> then needs to be randomly ordered.</p>
<p><strong>Comparison with simple sampling</strong></p>
<p>A comparison to simple sampling (white noise generation) can be found in the following figures.</p>
<div class="table-wrapper table-borderless docutils container">
<table class="table-borderless docutils align-default">
<tbody>
<tr class="row-odd"><td><figure class="align-center" id="id26">
<a class="dark-light reference internal image-reference" href="../_images/rect_simple_sampling.webp"><img alt="../_images/rect_simple_sampling.webp" class="dark-light" src="../_images/rect_simple_sampling.webp" style="width: 450px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5.1 </span><span class="caption-text">200k rays on a square area with simple uniform sampling, image rendered with 189 x 189 pixel</span><a class="headerlink" href="#id26" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-center" id="id27">
<a class="dark-light reference internal image-reference" href="../_images/rect_strat_sampling.webp"><img alt="../_images/rect_strat_sampling.webp" class="dark-light" src="../_images/rect_strat_sampling.webp" style="width: 450px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5.2 </span><span class="caption-text">200k rays on a square area with two dimensional stratified sampling, image rendered with 189 x 189 pixel</span><a class="headerlink" href="#id27" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="disc-annulus-sampling">
<span id="disc-mapping"></span><h2><span class="section-number">5.1.6. </span>Disc/Annulus Sampling<a class="headerlink" href="#disc-annulus-sampling" title="Link to this heading">¶</a></h2>
<p><strong>Polar Grid Transformation Artifacts</strong></p>
<p>Stratified sampling generates a rectangular grid, which for a circular surface needs to be transformed
into a polar grid. While this is done uniformly in <a class="reference internal" href="misc.html#circle-sampling"><span class="std std-numref">Section 5.9.4</span></a>,
there are some circular artefacts visible, especially at the center.</p>
<div class="table-wrapper table-borderless docutils container">
<table class="table-borderless docutils align-default">
<tbody>
<tr class="row-odd"><td><figure class="align-center" id="id28">
<a class="dark-light reference internal image-reference" href="../_images/circ_sampling_strat.webp"><img alt="../_images/circ_sampling_strat.webp" class="dark-light" src="../_images/circ_sampling_strat.webp" style="width: 450px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5.3 </span><span class="caption-text">200k rays with stratified sampling and a polar grid transformation as done in <a class="reference internal" href="misc.html#circle-sampling"><span class="std std-numref">Section 5.9.4</span></a>,
image rendered with 189 x 189 pixel</span><a class="headerlink" href="#id28" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-center" id="id29">
<a class="dark-light reference internal image-reference" href="../_images/circ_sampling_mapping.webp"><img alt="../_images/circ_sampling_mapping.webp" class="dark-light" src="../_images/circ_sampling_mapping.webp" style="width: 450px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5.4 </span><span class="caption-text">200k rays on a circular area with positions mapped from stratified grid,
image rendered with 189 x 189 pixel</span><a class="headerlink" href="#id29" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</td>
</tr>
</tbody>
</table>
</div>
<p>These artifacts arise from the highly distorted initial rectangular cells, that in those regions
become circular sectors.  At the disc edge the rectangular cells are less distorted.
In the inner region the area elements consist of small arc lengths and a large radial component,
while going further outside the arc lengths increase and the radial lengths decrease.
Near the center the area elements appear <em>zoomed in</em>. You can see such a grid and its distortion
in <a class="footnote-reference brackets" href="#footcite-doi-10-1080-10867651-1997-10487479" id="id15" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a>, figure 5, as well as the alternative method that is showcased next.</p>
<p>Although for many rays the mentioned artefacts become less and less visible, a different approach should be desirable.
This is especially important as the center of the disc typically lies at the optical axis or, when generating
direction distributions, at the center direction of the distribution volume.</p>
<p><strong>Square to Disc Mapping</strong></p>
<p>One improved method is the Square-Disc Mapping method from <a class="footnote-reference brackets" href="#footcite-doi-10-1080-10867651-1997-10487479" id="id16" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a>.
optrace implements a simplified method from <a class="footnote-reference brackets" href="#footcite-shirleycode" id="id17" role="doc-noteref"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></a>.
Sampled grid values <span class="math notranslate nohighlight">\(x,~y\)</span> lie inside a grid with bounds
<span class="math notranslate nohighlight">\(([-r_\text{o}, ~r_\text{o}], ~[-r_\text{o}, ~r_\text{o}])\)</span> and get transformed to radial disc coordinates with:</p>
<div class="math-wrapper docutils container" id="equation-square-disc-mapping">
<div class="math notranslate nohighlight" id="equation-square-disc-mapping">
<span class="eqno">(5.9)<a class="headerlink" href="#equation-square-disc-mapping" title="Link to this equation">¶</a></span>\[\begin{split}(r, \varphi)=
\begin{cases}\left(x, ~\frac{\pi}{4} \frac{y}{x}\right) &amp; \text { if } x^2&gt;y^2 \\
\left(y, ~\frac{\pi}{2}-\frac{\pi}{4} \frac{x}{y}\right) &amp; \text { if } x^2 \leq y^2 \text { and } y^2&gt;0 \\
(0,~0) &amp; \text { otherwise }
\end{cases}\end{split}\]</div>
</div>
<p>Where <span class="math notranslate nohighlight">\(r_\text{o}\)</span> is the outer radius of the circle. Note that <span class="math notranslate nohighlight">\(r\)</span> has a sign,
contrary to polar coordinates.</p>
<p><strong>Disc to Annulus Mapping</strong></p>
<p>When a annulus (surface between to concentric circles) is required, the disc coordinates can be transformed
by rescaling the radius <span class="math notranslate nohighlight">\(r\)</span> non-linearly. In <a class="reference internal" href="misc.html#ring-sampling"><span class="std std-numref">Section 5.9.4</span></a> we talk about how the linear values need
to be inserted into a square function to achieve an equal-area mapping for a ring.
The mapped radius <span class="math notranslate nohighlight">\(r_\text{A}\)</span> from an annulus with inner radius <span class="math notranslate nohighlight">\(r_\text{i}\)</span>, outer radius
<span class="math notranslate nohighlight">\(r_\text{o}\)</span> and radial coordinates <span class="math notranslate nohighlight">\(r \in [0,~r_\text{o}]\)</span> from <a class="reference internal" href="#equation-square-disc-mapping">(5.9)</a> is then:</p>
<div class="math-wrapper docutils container" id="equation-disc-annulus-mapping">
<div class="math notranslate nohighlight" id="equation-disc-annulus-mapping">
<span class="eqno">(5.10)<a class="headerlink" href="#equation-disc-annulus-mapping" title="Link to this equation">¶</a></span>\[\begin{split}r_\text{A} =
\begin{cases}
\text{sign}(r) \sqrt{r^2_\text{i} + r^2 \left(1 - \frac{r^2_\text{i}}{r^2_\text{o}}\right)} &amp; \text{ if } r \neq 0\\
r_\text{i} &amp; \text{ if } r = 0\\
\end{cases}\end{split}\]</div>
</div>
</section>
<section id="power-sampling">
<h2><span class="section-number">5.1.7. </span>Power Sampling<a class="headerlink" href="#power-sampling" title="Link to this heading">¶</a></h2>
<p>The same power value is assigned to all rays.</p>
</section>
<section id="polarization-sampling">
<span id="id18"></span><h2><span class="section-number">5.1.8. </span>Polarization Sampling<a class="headerlink" href="#polarization-sampling" title="Link to this heading">¶</a></h2>
<p>For generating linear ray polarizations the procedure in <a class="reference internal" href="tracing.html#tracing-pol"><span class="std std-numref">Section 5.2.3</span></a> is applied.
<span class="math notranslate nohighlight">\(s = [0, 0, 1]\)</span> is a vector parallel to the optical axis and <span class="math notranslate nohighlight">\(s' \in \mathcal{S}\)</span> from the directions
generated above. The initial polarization <span class="math notranslate nohighlight">\(E\)</span> lies in the xy-plane and has some randomly distributed angle
<span class="math notranslate nohighlight">\(\mathcal{A}\)</span> inside this plane.</p>
<div class="math-wrapper docutils container" id="equation-eq-pol-sampling-e">
<div class="math notranslate nohighlight" id="equation-eq-pol-sampling-e">
<span class="eqno">(5.11)<a class="headerlink" href="#equation-eq-pol-sampling-e" title="Link to this equation">¶</a></span>\[\begin{split}E = \begin{pmatrix}  \cos \mathcal{A}\\ \sin \mathcal{A}\\ 0 \end{pmatrix}\end{split}\]</div>
</div>
<p>Following this procedure, we get <span class="math notranslate nohighlight">\(E'\)</span>, which is the polarization vector at the source.</p>
<p>The advantage of simulating the polarization vector after a virtual lens can be demonstrated
using the following example:</p>
<ol class="arabic simple">
<li><p>Generating ray vectors <span class="math notranslate nohighlight">\(e_z = [0, 0, 1]\)</span> with an polarization angle <span class="math notranslate nohighlight">\(\alpha\)</span>.
These rays get focused by an ideal lens, that has a well-defined focal point.
Rays in this focal point have some vector distribution <span class="math notranslate nohighlight">\(\mathcal{S}\)</span> and a polarization distribution
<span class="math notranslate nohighlight">\(\mathcal{E}'\)</span>. The focal point can be seen as a point source.</p></li>
<li><p>Generating a point source with the same orientation vector distribution <span class="math notranslate nohighlight">\(\mathcal{S}\)</span>
and polarization angle <span class="math notranslate nohighlight">\(\alpha\)</span> creates the same polarization distribution <span class="math notranslate nohighlight">\(\mathcal{E}\)</span>’
as in point 1. We can therefore omit this lens from before.</p></li>
</ol>
<p>With this concept in mind, it now should be clear, what providing a fixed polarization angle or distribution means for
different source ray directions.</p>
<p>The following angle distributions <span class="math notranslate nohighlight">\(\mathcal{A}\)</span> with <span class="math notranslate nohighlight">\(\alpha \in \mathcal{A}\)</span> are available:</p>
<div class="table-wrapper colwidths-given docutils container" id="id30">
<table class="docutils align-center" id="id30">
<caption><span class="caption-number">Table 5.2 </span><span class="caption-text">Polarization angle modes</span><a class="headerlink" href="#id30" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 27.3%" />
<col style="width: 72.7%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>x-Polarization</strong></p></td>
<td><p><span class="math notranslate nohighlight">\(\alpha = 0^{\circ}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><strong>y-Polarization</strong></p></td>
<td><p><span class="math notranslate nohighlight">\(\alpha = 90^{\circ}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Constant Angle</strong></p></td>
<td><p><span class="math notranslate nohighlight">\(\alpha = \alpha_0\)</span></p></td>
</tr>
<tr class="row-even"><td><p><strong>xy-Polarization</strong></p></td>
<td><p><span class="math notranslate nohighlight">\(\alpha\)</span> randomly chosen from <span class="math notranslate nohighlight">\(\{0^{\circ},~90^{\circ}\}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Uniformly distributed</strong></p></td>
<td><p><span class="math notranslate nohighlight">\(\mathcal{A} = \mathcal{U}_{[0, ~2\pi]}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><strong>User Function</strong></p></td>
<td><div class="line-block">
<div class="line">function <span class="math notranslate nohighlight">\(f(\alpha)\)</span></div>
<div class="line"><span class="math notranslate nohighlight">\(\mathcal{A} = F^{-1}\left(\mathcal{U}_{[F(\alpha_0), ~F(\alpha_1)]}\right)\)</span></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><strong>List</strong></p></td>
<td><div class="line-block">
<div class="line">angles <span class="math notranslate nohighlight">\(A=\left\{\alpha_0, ~\alpha_1,~\dots\right\}\)</span>
with probabilities <span class="math notranslate nohighlight">\(P=\left\{p_0, ~p_1,~\dots\right\}\)</span></div>
<div class="line"><span class="math notranslate nohighlight">\(\alpha\)</span> gets then chosen randomly from <span class="math notranslate nohighlight">\(A\)</span> according to <span class="math notranslate nohighlight">\(P\)</span></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="position-sampling">
<span id="random-positions-surfaces"></span><h2><span class="section-number">5.1.9. </span>Position Sampling<a class="headerlink" href="#position-sampling" title="Link to this heading">¶</a></h2>
<p>If a source image is specified, the positions are chosen randomly according to the effective intensity distribution
of the image, see <a class="reference internal" href="color.html#random-srgb"><span class="std std-numref">Section 5.8.5</span></a>.</p>
<p>When no image is specified, positions are chosen randomly inside the source area,
whereas the ray position probability density is uniformly random.</p>
<p>A <strong>Point</strong> source requires no sampling.
1D stratified sampling is employed for a <strong>Line</strong> source.
A <strong>Rectangle</strong> surface is sampled by the 2D stratified sampling.
For arbitrary rectangle aspect ratios the square sample grid cells become rectangular.
A <strong>Circle</strong> or <strong>Ring</strong> surface get sampled according to the Disc/Annulus sampling section.</p>
<section id="spectrum-sampling">
<span id="random-wavelengths"></span><h3><span class="section-number">5.1.9.1. </span>Spectrum Sampling<a class="headerlink" href="#spectrum-sampling" title="Link to this heading">¶</a></h3>
<p>For a ray source with a sRGB image wavelengths are generated according to <a class="reference internal" href="color.html#random-srgb"><span class="std std-numref">Section 5.8.5</span></a>.
In all other cases the wavelengths are chosen randomly according to a specified spectrum.</p>
<p>A <strong>Monochromatic</strong> type spectrum requires no random sampling.
Sampling for <strong>Lines</strong> is implemented by a random selection of all wavelengths with weights proportional to their power.
For types <strong>Constant</strong> and <strong>Rectangle</strong> the stratified 1D sampling is applied.
Inverse transform sampling is applied for types <strong>User Function/ User Data / Blackbody</strong>.</p>
<p>A <strong>Gaussian</strong> type spectrum is truncated to allow only wavelength inside the visible spectrum.
<span class="math notranslate nohighlight">\(\lambda\)</span> is limited to <span class="math notranslate nohighlight">\(\lambda \in [\lambda_l,~\lambda_r]\)</span>.
For this function the anti-derivative integration bounds <span class="math notranslate nohighlight">\(\xi_a,~\xi_b\)</span>
need to be calculated first before performing the inverse transform method.</p>
<div class="math-wrapper docutils container" id="equation-gaussian-trunc-lambda-bounds">
<div class="math notranslate nohighlight" id="equation-gaussian-trunc-lambda-bounds">
<span class="eqno">(5.12)<a class="headerlink" href="#equation-gaussian-trunc-lambda-bounds" title="Link to this equation">¶</a></span>\[\begin{split}\xi_a =&amp;~ \frac{1}{2}\left(1 + \text{erf}\left(\frac{\lambda_\text{l}
         - \lambda_0}{\sqrt{2} \sigma_\lambda}\right)\right)\\
\xi_b =&amp;~ \frac{1}{2}\left(1 + \text{erf}\left(\frac{\lambda_\text{r}
         - \lambda_0}{\sqrt{2} \sigma_\lambda}\right)\right)\end{split}\]</div>
</div>
<p>Where <span class="math notranslate nohighlight">\(\lambda_0\)</span> is the center wavelength and <span class="math notranslate nohighlight">\(\sigma_\lambda\)</span> the standard deviation.
With these bounds the random wavelengths are then:</p>
<div class="math-wrapper docutils container" id="equation-gaussian-trunc-lambda">
<div class="math notranslate nohighlight" id="equation-gaussian-trunc-lambda">
<span class="eqno">(5.13)<a class="headerlink" href="#equation-gaussian-trunc-lambda" title="Link to this equation">¶</a></span>\[\Lambda = \lambda_0 + \sqrt{2} ~ \sigma_\lambda ~  \text{erf}^{-1}\left(2\,\mathcal{U}_{[\xi_a, ~\xi_b]}-1\right)\]</div>
</div>
</section>
</section>
<section id="direction-cone">
<span id="id19"></span><h2><span class="section-number">5.1.10. </span>Direction Cone<a class="headerlink" href="#direction-cone" title="Link to this heading">¶</a></h2>
<p>Modelling diffuse light emission is implemented by distributing ray directions around a base orientation <span class="math notranslate nohighlight">\(s_0\)</span>.
Around this vector rays are distributed inside a cone with half opening angle <span class="math notranslate nohighlight">\(\theta_\text{max}\)</span>
with <span class="math notranslate nohighlight">\(0  \leq \theta_\text{max} &lt; \frac{\pi}{2}\)</span>.
A direction vector <span class="math notranslate nohighlight">\(s\)</span> may have some opening angle <span class="math notranslate nohighlight">\(\theta\)</span>
with <span class="math notranslate nohighlight">\(0 \leq \theta \leq \theta_\text{max}\)</span> and an angle <span class="math notranslate nohighlight">\(\alpha\)</span> inside the <span class="math notranslate nohighlight">\(s_x,~s_y\)</span>-plane
perpendicular to the base cone orientation <span class="math notranslate nohighlight">\(s_0\)</span>.
However, <span class="math notranslate nohighlight">\(s_x,~s_y\)</span> are not parallel to the cartesian <span class="math notranslate nohighlight">\(x,y,z\)</span> axes, but arise
from a vector multiplication of the cartesian axis and the base vector.</p>
<figure class="align-center" id="id31">
<a class="dark-light reference internal image-reference" href="../_images/direction_cone.svg"><img alt="../_images/direction_cone.svg" class="dark-light" src="../_images/direction_cone.svg" style="width: 450px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5.5 </span><span class="caption-text">Exemplary direction vector <span class="math notranslate nohighlight">\(s\)</span> inside a cone volume around <span class="math notranslate nohighlight">\(s_0\)</span></span><a class="headerlink" href="#id31" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>With <span class="math notranslate nohighlight">\(x = [1, 0, 0]\)</span> and <span class="math notranslate nohighlight">\(s_0\)</span> being the base orientation unity vector for the cone the vectors
<span class="math notranslate nohighlight">\(s_x,s_y\)</span> are calculated using vector products:</p>
<div class="math-wrapper docutils container" id="equation-eq-direction-cone-pars">
<div class="math notranslate nohighlight" id="equation-eq-direction-cone-pars">
<span class="eqno">(5.14)<a class="headerlink" href="#equation-eq-direction-cone-pars" title="Link to this equation">¶</a></span>\[\begin{split}\begin{align}
 s_y =&amp;~ \frac{x \times s_0}{||x \times s_0||}\\
 s_x =&amp;~ s_0 \times s_y
\end{align}\end{split}\]</div>
</div>
<p>Ray direction <span class="math notranslate nohighlight">\(s\)</span> is composed of the base vector <span class="math notranslate nohighlight">\(s_0\)</span> and a perpendicular component
<span class="math notranslate nohighlight">\(s_r = s_x \cos \alpha + s_y \sin \alpha\)</span>.
Keeping trigonometric relations in mind, the resulting vector is also an unity vector, like all the input vectors.</p>
<div class="math-wrapper docutils container" id="equation-eq-direction-cone">
<div class="math notranslate nohighlight" id="equation-eq-direction-cone">
<span class="eqno">(5.15)<a class="headerlink" href="#equation-eq-direction-cone" title="Link to this equation">¶</a></span>\[s = s_0 \cos \theta + \left( s_x \cos \alpha + s_y \sin \alpha\right) \sin \theta\]</div>
</div>
<p>The corresponding random variables for <span class="math notranslate nohighlight">\(\theta,~\alpha,~s\)</span> are <span class="math notranslate nohighlight">\(\Theta,~\mathcal{A},~\mathcal{S}\)</span>.</p>
</section>
<section id="d-direction-sampling">
<h2><span class="section-number">5.1.11. </span>2D Direction Sampling<a class="headerlink" href="#d-direction-sampling" title="Link to this heading">¶</a></h2>
<p>Ray directions are distributed inside a plane, which is a cross section of the cone in
<a class="reference internal" href="#direction-cone"><span class="std std-numref">Section 5.1.10</span></a> including <span class="math notranslate nohighlight">\(s_0\)</span>. Let <span class="math notranslate nohighlight">\(\mathcal{A}\)</span> be the random variable for <span class="math notranslate nohighlight">\(\alpha\)</span>
with sample space <span class="math notranslate nohighlight">\(\Omega_\alpha = \{\alpha_0, ~\alpha_0 + \pi\}\)</span> with equal probability for each value.
While <span class="math notranslate nohighlight">\(\mathcal{A}\)</span> is equal for all elements, distribution <span class="math notranslate nohighlight">\(\Theta\)</span>
differs according to the desired behavior:</p>
<p><strong>Function</strong></p>
<p>For a function <span class="math notranslate nohighlight">\(f(\theta)\)</span> with <span class="math notranslate nohighlight">\(\theta \in [0, ~\theta_\text{max}]\)</span> and
<span class="math notranslate nohighlight">\(0 &lt; ~\theta_\text{max} \leq ~\frac{\pi}{2}\)</span> we can apply the inverse sampling theorem
<a class="reference internal" href="#equation-its-t-interval">(5.4)</a>:</p>
<div class="math-wrapper docutils container" id="equation-eq-dir-2d-func">
<div class="math notranslate nohighlight" id="equation-eq-dir-2d-func">
<span class="eqno">(5.16)<a class="headerlink" href="#equation-eq-dir-2d-func" title="Link to this equation">¶</a></span>\[\Theta = \text{F}^{-1}\left(\mathcal{U}_{[\text{F}(0),~\text{F}(\theta_\text{max})]}\right)\]</div>
</div>
<p><strong>Isotropic</strong></p>
<p>Isotropic means nothing different than uniformly in all directions, which here just means:</p>
<div class="math-wrapper docutils container" id="equation-eq-dir-2d-iso">
<div class="math notranslate nohighlight" id="equation-eq-dir-2d-iso">
<span class="eqno">(5.17)<a class="headerlink" href="#equation-eq-dir-2d-iso" title="Link to this equation">¶</a></span>\[\Theta = \mathcal{U}_{[0, ~\theta_\text{max}]}\]</div>
</div>
<p><strong>Lambertian</strong></p>
<p>A Lambertian radiator follows the cosine law. With <span class="math notranslate nohighlight">\(f(\theta) = \cos \theta\)</span>,
<span class="math notranslate nohighlight">\(F(\theta) = \sin \theta\)</span> and <span class="math notranslate nohighlight">\(F^{-1}(F) = \arcsin(F)\)</span> inverse transform sampling can be performed:</p>
<div class="math-wrapper docutils container" id="equation-eq-dir-2d-lambert">
<div class="math notranslate nohighlight" id="equation-eq-dir-2d-lambert">
<span class="eqno">(5.18)<a class="headerlink" href="#equation-eq-dir-2d-lambert" title="Link to this equation">¶</a></span>\[\Theta = \arcsin \left(\mathcal{U}_{[0,~\sin \theta_\text{max}]}\right)\]</div>
</div>
</section>
<section id="id20">
<h2><span class="section-number">5.1.12. </span>3D Direction sampling<a class="headerlink" href="#id20" title="Link to this heading">¶</a></h2>
<p>For generating a direction cone two random variables are needed. To achieve an uniform,
stratified and artefact free distribution, the disc mapping from <a class="reference internal" href="#disc-mapping"><span class="std std-numref">Section 5.1.6</span></a> is applied.
The random variable <span class="math notranslate nohighlight">\(\mathcal{A}\)</span> for values of <span class="math notranslate nohighlight">\(\alpha\)</span> is made of values of <span class="math notranslate nohighlight">\(\theta\)</span> from
disc mapping. The second uniform variable <span class="math notranslate nohighlight">\(\mathcal{U}\)</span> is then the radius squared <span class="math notranslate nohighlight">\(r^2\)</span>
and normalized by the squared disc radius.</p>
<div class="math-wrapper docutils container" id="equation-eq-3d-direction-mapping-uniform">
<div class="math notranslate nohighlight" id="equation-eq-3d-direction-mapping-uniform">
<span class="eqno">(5.19)<a class="headerlink" href="#equation-eq-3d-direction-mapping-uniform" title="Link to this equation">¶</a></span>\[\mathcal{U}_{[0,~1]} = \frac{r^2}{r^2_\text{o}}\]</div>
</div>
<p>Squaring is necessary as the values are uniformly distributed according to the area, but we need uniformly
distributed values according to the radius. The inverse transformation for this is known from <a class="reference internal" href="misc.html#circle-sampling"><span class="std std-numref">Section 5.9.4</span></a>.
Rescaling this uniform variable into the desired output range is a simple linear transformation.</p>
<p><strong>Function</strong></p>
<p>Let <span class="math notranslate nohighlight">\(f(\theta)\)</span> be a user function with <span class="math notranslate nohighlight">\(\theta \in [0, ~\theta_\text{max}]\)</span> with
<span class="math notranslate nohighlight">\(0 &lt; \theta_\text{max} \leq \frac{\pi}{2}\)</span>.
In three dimensions <span class="math notranslate nohighlight">\(f(\theta)\)</span> needs to be scaled with <span class="math notranslate nohighlight">\(\sin \theta\)</span>
for the distribution function, see <a class="footnote-reference brackets" href="#footcite-scratchtracing" id="id21" role="doc-noteref"><span class="fn-bracket">[</span>11<span class="fn-bracket">]</span></a> under <em>Create samples on the hemisphere</em>.</p>
<p><span class="math notranslate nohighlight">\(g(\theta)\)</span> is then defined as <span class="math notranslate nohighlight">\(g(\theta) := f(\theta) \sin \theta\)</span>.
We can apply the inverse sampling theorem <a class="reference internal" href="#equation-its-t-interval">(5.4)</a> on this new function:</p>
<div class="math-wrapper docutils container" id="equation-eq-dir-3d-func">
<div class="math notranslate nohighlight" id="equation-eq-dir-3d-func">
<span class="eqno">(5.20)<a class="headerlink" href="#equation-eq-dir-3d-func" title="Link to this equation">¶</a></span>\[\Theta = \text{G}^{-1}\left(\mathcal{U}_{[\text{G}(0),~\text{G}(\theta_\text{max})]}\right)\]</div>
</div>
<p><strong>Isotropic</strong></p>
<p>With <span class="math notranslate nohighlight">\(f(\theta) = 1\)</span> we get <span class="math notranslate nohighlight">\(g(\theta) = \sin \theta\)</span> and <span class="math notranslate nohighlight">\(G(\theta) = 1-\cos \theta\)</span> and
<span class="math notranslate nohighlight">\(G^{-1}(G) = \arccos (1-G)\)</span>. Bounds are <span class="math notranslate nohighlight">\(G \in [0, ~1-\cos \theta_\text{max}]\)</span>
and <span class="math notranslate nohighlight">\(1 - G \in [1, ~\cos \theta_\text{max}]\)</span>. The latter get swapped to ensure ascending bounds.</p>
<div class="math-wrapper docutils container" id="equation-eq-dir-3d-iso">
<div class="math notranslate nohighlight" id="equation-eq-dir-3d-iso">
<span class="eqno">(5.21)<a class="headerlink" href="#equation-eq-dir-3d-iso" title="Link to this equation">¶</a></span>\[\Theta = \arccos\left(\mathcal{U}_{[\cos \theta_\text{max}, ~1]}\right)\]</div>
</div>
<p>This is consistent with <a class="footnote-reference brackets" href="#footcite-wolframspherepicking" id="id22" role="doc-noteref"><span class="fn-bracket">[</span>12<span class="fn-bracket">]</span></a>.</p>
<p><strong>Lambertian</strong></p>
<p>For <span class="math notranslate nohighlight">\(f(\theta) = \cos \theta\)</span>  we get <span class="math notranslate nohighlight">\(g(\theta) = \cos \theta \sin \theta\)</span>
and <span class="math notranslate nohighlight">\(G(\theta) = \frac{1}{2} \sin^2 \theta\)</span>.
The anti-derivative inverse is then <span class="math notranslate nohighlight">\(G^{-1}(G) = \arcsin \sqrt{2G}\)</span>
with bounds <span class="math notranslate nohighlight">\(\{0, ~\frac{1}{2}\sin^2 \theta_\text{max}\}\)</span>.
A uniform random variable <span class="math notranslate nohighlight">\(2G\)</span> is then bound to <span class="math notranslate nohighlight">\(\{0, \sin^2 \theta_\text{max}\}\)</span>.</p>
<p>For the angle distributions we get a form that is consistent with <a class="footnote-reference brackets" href="#footcite-particlecosine" id="id23" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a>:</p>
<div class="math-wrapper docutils container" id="equation-eq-dir-3d-lambert">
<div class="math notranslate nohighlight" id="equation-eq-dir-3d-lambert">
<span class="eqno">(5.22)<a class="headerlink" href="#equation-eq-dir-3d-lambert" title="Link to this equation">¶</a></span>\[\Theta = \arcsin\left(\sqrt{\mathcal{U}_{[0, ~\sin^2 \theta_\text{max}]}}\right)\]</div>
</div>
<hr class="docutils" />
<p><strong>References</strong></p>
<div class="docutils container" id="id24">
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="footcite-scratchestimators" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Scratchapixel. Mathematical Foundations of Monte Carlo Methods. 2022. URL: <a class="reference external" href="https://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/monte-carlo-methods-mathematical-foundations/estimators.html">https://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/monte-carlo-methods-mathematical-foundations/estimators.html</a> (visited on 2022-12-01).</p>
</aside>
<aside class="footnote brackets" id="footcite-raytracingcook" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>Robert L. Cook. <em>Stochastic Sampling and Distributed Ray Tracing</em>, pages 161–162. Acadenuc Press Limited, 1989.</p>
</aside>
<aside class="footnote brackets" id="footcite-scratchmontecarlo" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p>Scratchapixel. Monte Carlo Methods in Practice. 2022. URL: <a class="reference external" href="https://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/monte-carlo-methods-in-practice/introduction-quasi-monte-carlo.html">https://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/monte-carlo-methods-in-practice/introduction-quasi-monte-carlo.html</a> (visited on 2022-12-12).</p>
</aside>
<aside class="footnote brackets" id="footcite-teschnersampling" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">4</a><span class="fn-bracket">]</span></span>
<p>Matthias Teschner. Advanced Computer Graphics - Sampling. 2015. URL: <a class="reference external" href="https://cg.informatik.uni-freiburg.de/course_notes/graphics2_04_sampling.pdf">https://cg.informatik.uni-freiburg.de/course_notes/graphics2_04_sampling.pdf</a> (visited on 2022-12-12).</p>
</aside>
<aside class="footnote brackets" id="footcite-itswiki" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id5">1</a>,<a role="doc-backlink" href="#id6">2</a>)</span>
<p>Wikipedia. Inverse transform sampling. 2022. URL: <a class="reference external" href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">https://en.wikipedia.org/wiki/Inverse_transform_sampling</a> (visited on 2022-12-01).</p>
</aside>
<aside class="footnote brackets" id="footcite-wicklin-2013" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">6</a><span class="fn-bracket">]</span></span>
<p>Rick Wicklin. The inverse cdf method for simulating from a distribution. 2013. URL: <a class="reference external" href="https://blogs.sas.com/content/iml/2013/07/22/the-inverse-cdf-method.html">https://blogs.sas.com/content/iml/2013/07/22/the-inverse-cdf-method.html</a> (visited on 2025-03-07).</p>
</aside>
<aside class="footnote brackets" id="footcite-perrier-tel-01801347" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id9">1</a>,<a role="doc-backlink" href="#id10">2</a>,<a role="doc-backlink" href="#id11">3</a>,<a role="doc-backlink" href="#id12">4</a>,<a role="doc-backlink" href="#id13">5</a>)</span>
<p>Helène Perrier. <em>Anti-Aliased Low Discrepancy Samplers for Monte Carlo Estimators in Physically Based Rendering</em>. Theses, Université de Lyon, March 2018. URL: <a class="reference external" href="https://theses.hal.science/tel-01801347">https://theses.hal.science/tel-01801347</a>.</p>
</aside>
<aside class="footnote brackets" id="footcite-wolfediscrepancy" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id14">8</a><span class="fn-bracket">]</span></span>
<p>Alan Wolfe. When Random Numbers Are Too Random: Low Discrepancy Sequences. 2017. URL: <a class="reference external" href="https://blog.demofox.org/2017/05/29/when-random-numbers-are-too-random-low-discrepancy-sequences/">https://blog.demofox.org/2017/05/29/when-random-numbers-are-too-random-low-discrepancy-sequences/</a> (visited on 2022-12-01).</p>
</aside>
<aside class="footnote brackets" id="footcite-doi-10-1080-10867651-1997-10487479" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id15">1</a>,<a role="doc-backlink" href="#id16">2</a>)</span>
<p>Peter Shirley and Kenneth Chiu. A low distortion map between disk and square. <em>Journal of Graphics Tools</em>, 2(3):45–52, 1997. <a class="reference external" href="https://doi.org/10.1080/10867651.1997.10487479">doi:10.1080/10867651.1997.10487479</a>.</p>
</aside>
<aside class="footnote brackets" id="footcite-shirleycode" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id17">10</a><span class="fn-bracket">]</span></span>
<p>Pete Shirley. Improved code for concentric map. 2011. URL: <a class="reference external" href="https://psgraphics.blogspot.com/2011/01/improved-code-for-concentric-map.html">https://psgraphics.blogspot.com/2011/01/improved-code-for-concentric-map.html</a> (visited on 2022-12-17).</p>
</aside>
<aside class="footnote brackets" id="footcite-scratchtracing" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id21">11</a><span class="fn-bracket">]</span></span>
<p>Scratchapixel. Global Illumination and Path Tracing. 2022. URL: <a class="reference external" href="https://www.scratchapixel.com/lessons/3d-basic-rendering/global-illumination-path-tracing/global-illumination-path-tracing-practical-implementation.html">https://www.scratchapixel.com/lessons/3d-basic-rendering/global-illumination-path-tracing/global-illumination-path-tracing-practical-implementation.html</a> (visited on 2022-12-06).</p>
</aside>
<aside class="footnote brackets" id="footcite-wolframspherepicking" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id22">12</a><span class="fn-bracket">]</span></span>
<p>Wolfram MathWorld. Sphere Point Picking. 2022. URL: <a class="reference external" href="https://mathworld.wolfram.com/SpherePointPicking.html">https://mathworld.wolfram.com/SpherePointPicking.html</a> (visited on 2022-12-06).</p>
</aside>
<aside class="footnote brackets" id="footcite-particlecosine" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id23">13</a><span class="fn-bracket">]</span></span>
<p>Particle In Cell Consulting LLC. Modeling Diffuse Reflection (or How to Sample Cosine Distribution). 2015. URL: <a class="reference external" href="https://www.particleincell.com/2015/cosine-distribution/">https://www.particleincell.com/2015/cosine-distribution/</a> (visited on 2022-12-06).</p>
</aside>
</aside>
</div>
</section>
</section>

        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="index.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title"><span class="section-number">5. </span>Implementation Details</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="tracing.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title"><span class="section-number">5.2. </span>Tracing Procedure</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright">
      &copy; 2025, Damian Mendroch &nbsp;  &nbsp; 
      <a href="../impressum.html" style="color: var(--pst-color-text-muted)">Impressum</a>
      &nbsp; &nbsp; 
      <a href="../impressum.html" style="color: var(--pst-color-text-muted)">Legal Notice</a>
      <br>
  
    </div>
    <div class="sy-foot-copyright">
      <p>
        Made with
    
        <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
        <a href="https://shibuya.lepture.com">Shibuya theme</a>.
      </p>
    </div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=5b045848"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/shibuya.js?v=e730760c"></script>
      <script>window.MathJax = {"loader": {"load": ["ui/lazy"]}, "options": {"lazyMargin": "400px", "lazyAlwaysTypeset": null}}</script>
      <script defer="defer" src="../_static/mathjax/tex-chtml.js"></script></body>
</html>